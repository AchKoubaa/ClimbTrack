<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ClimbTrack.ViewModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="ClimbTrack.Views.EditProfilePage"
             x:DataType="viewmodels:EditProfileViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <StackLayout Padding="20">
            <!-- Profile Image Section -->
            <StackLayout Orientation="Vertical" Spacing="10">
                <Frame CornerRadius="75" HeightRequest="150" WidthRequest="150" 
                       Padding="0" IsClippedToBounds="True" 
                       HorizontalOptions="Center" BorderColor="{StaticResource PrimaryColor}">
                    <Grid>
                        <!-- Default image or initials when no photo is available -->
                        <StackLayout IsVisible="{Binding UserProfile.HasPhoto, Converter={StaticResource InvertedBoolConverter}}"
                                    BackgroundColor="{StaticResource PrimaryColor}"
                                    HorizontalOptions="Fill"
                                    VerticalOptions="Fill">
                            <Label Text="{Binding UserProfile.Initials}"
                                   TextColor="White"
                                   FontSize="48"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   AutomationProperties.Name="Iniziali Profilo" />
                        </StackLayout>

                        <!-- Selected profile image -->
                        <Image Source="{Binding UserProfile.PhotoUrl}"
                               IsVisible="{Binding UserProfile.HasPhoto}"
                               Aspect="AspectFill"
                               HeightRequest="150" WidthRequest="150"
                               AutomationProperties.Name="Foto Profilo" />
                    </Grid>
                </Frame>

                <Button Text="Seleziona Foto" 
                        Command="{Binding PickPhotoCommand}"
                        Style="{StaticResource SecondaryButtonStyle}"
                        HorizontalOptions="Center"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                        AutomationProperties.Name="Seleziona Foto"
                        AutomationProperties.HelpText="Premi per selezionare una nuova foto profilo" />
            </StackLayout>

            <!-- Rest of your form fields -->
            <Label Text="Nome Visualizzato" 
                   Style="{StaticResource FormLabelStyle}"
                   AutomationProperties.Name="Etichetta Nome Visualizzato" />
            <Entry Text="{Binding UserProfile.DisplayName}" 
                   Style="{StaticResource FormEntryStyle}"
                   AutomationProperties.Name="Nome Visualizzato"
                   AutomationProperties.HelpText="Inserisci il tuo nome visualizzato" />

            <Label Text="Email" 
                   Style="{StaticResource FormLabelStyle}"
                   AutomationProperties.Name="Etichetta Email" />
            <Entry Text="{Binding UserProfile.Email}" 
                   IsEnabled="False" 
                   Style="{StaticResource FormEntryStyle}"
                   AutomationProperties.Name="Email"
                   AutomationProperties.HelpText="La tua email non puÃ² essere modificata" />

            <Label Text="Bio" 
                   Style="{StaticResource FormLabelStyle}"
                   AutomationProperties.Name="Etichetta Bio" />
            <Editor Text="{Binding UserProfile.Bio}" 
                    Style="{StaticResource FormEditorStyle}" 
                    HeightRequest="100"
                    AutomationProperties.Name="Bio"
                    AutomationProperties.HelpText="Inserisci una breve biografia" />

            <Label Text="Palestra Preferita" 
                   Style="{StaticResource FormLabelStyle}"
                   AutomationProperties.Name="Etichetta Palestra Preferita" />
            <Entry Text="{Binding UserProfile.PreferredGym}" 
                   Style="{StaticResource FormEntryStyle}"
                   AutomationProperties.Name="Palestra Preferita"
                   AutomationProperties.HelpText="Inserisci il nome della tua palestra preferita" />

            <!-- Indicatore di caricamento -->
            <ActivityIndicator IsRunning="{Binding IsBusy}" 
                               IsVisible="{Binding IsBusy}"
                               Color="{StaticResource PrimaryColor}"
                               HorizontalOptions="Center"
                               Margin="0,10,0,10"
                               AutomationProperties.Name="Caricamento in corso"
                               AutomationProperties.IsInAccessibleTree="{Binding IsBusy}" />

            <Button Text="Salva Modifiche" 
                    Command="{Binding SaveCommand}" 
                    Style="{StaticResource ActionButtonStyle}"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    AutomationProperties.Name="Salva Modifiche"
                    AutomationProperties.HelpText="Premi per salvare le modifiche al profilo" />

            <Button Text="Annulla" 
                    Command="{Binding CancelCommand}" 
                    Style="{StaticResource CancelButtonStyle}"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    AutomationProperties.Name="Annulla"
                    AutomationProperties.HelpText="Premi per annullare le modifiche e tornare indietro" />
        </StackLayout>
    </ScrollView>
</ContentPage>