<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ClimbTrack.ViewModels"
             xmlns:charts="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
             xmlns:models="clr-namespace:ClimbTrack.Models"
             xmlns:converters="clr-namespace:ClimbTrack.Converters"
             x:Class="ClimbTrack.Views.DashboardPage"
             x:DataType="viewmodels:DashboardViewModel"
             Title="{Binding Title}"
             >
    
    <ContentPage.Resources>
        <ResourceDictionary>
             <!--Converters--> 
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <ScrollView>
            <Grid Padding="15" RowSpacing="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                 <!--No Data View--> 
                <VerticalStackLayout IsVisible="{Binding HasData, Converter={StaticResource InverseBoolConverter}}"
                                     VerticalOptions="Center" HorizontalOptions="Center" Spacing="20" Margin="0,50,0,0">
                    <Image Source="no_data.png" HeightRequest="120" 
                           />
                    <Label Text="No training data yet" 
                           FontSize="20" 
                           FontAttributes="Bold" 
                           HorizontalOptions="Center"
                           />
                    <Label Text="Complete your first training session to see your statistics here" 
                           FontSize="16" 
                           TextColor="#666666" 
                           HorizontalOptions="Center" 
                           HorizontalTextAlignment="Center"
                           />
                    <Button Text="Start Training" 
                            Command="{Binding GoToTrainingCommand}" 
                            BackgroundColor="#3498db" 
                            TextColor="White" 
                            CornerRadius="20" 
                            Padding="20,10" 
                            Margin="0,20,0,0"
                           
                            />
                </VerticalStackLayout>

                 <!--Dashboard Content--> 
                <VerticalStackLayout IsVisible="{Binding HasData}" Spacing="15">
                    <!--Summary Cards-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <VerticalStackLayout>
                            <Label Text="Training Summary" 
               Style="{StaticResource CardTitleStyle}"
              />

                            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="15" RowSpacing="15">
                                <!--Sessions-->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                                    <Label Text="Total Sessions" 
                       Style="{StaticResource StatLabelStyle}"
                       />
                                    <Label Text="{Binding TotalSessions}" 
                       Style="{StaticResource StatValueStyle}"
                       />
                                </VerticalStackLayout>

                                <!--Routes-->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="1">
                                    <Label Text="Routes Completed" 
                       Style="{StaticResource StatLabelStyle}"
                       />
                                    <Label Text="{Binding TotalRoutesCompleted}" 
                       Style="{StaticResource StatValueStyle}"
                       />
                                </VerticalStackLayout>

                                <!--Completion Rate-->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="0">
                                    <Label Text="Completion Rate" 
                       Style="{StaticResource StatLabelStyle}"
                       />
                                    <Label Text="{Binding CompletionRate}" 
                       Style="{StaticResource StatValueStyle}"
                       />
                                </VerticalStackLayout>

                                <!--Total Time-->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="1">
                                    <Label Text="Total Training Time" 
                       Style="{StaticResource StatLabelStyle}"
                       />
                                    <Label Text="{Binding TotalTrainingTime}" 
                       Style="{StaticResource StatValueStyle}"
                       />
                                </VerticalStackLayout>

                                <!--Average Session Time-->
                                <VerticalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2">
                                    <Label Text="Average Session Duration" 
                       Style="{StaticResource StatLabelStyle}"
                       />
                                    <Label Text="{Binding AverageSessionTime}" 
                       Style="{StaticResource StatValueStyle}"
                       />
                                </VerticalStackLayout>
                            </Grid>
                        </VerticalStackLayout>
                    </Border>

                    <!--Training Frequency Chart-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <Grid>
                            <VerticalStackLayout>
                                <Label Text="Training Frequency" 
                   Style="{StaticResource CardTitleStyle}"
                   />
                                <Label Text="Number of sessions in the last 14 days" 
                   Style="{StaticResource ChartSubtitleStyle}"
                   />
                                <charts:ChartView Chart="{Binding TrainingFrequencyChart}" 
                             Style="{StaticResource ChartContainerStyle}"
                             />
                            </VerticalStackLayout>

                            <!--Chart Loading Indicator-->
                            <ActivityIndicator IsRunning="{Binding IsTrainingFrequencyChartLoading}" 
                           IsVisible="{Binding IsTrainingFrequencyChartLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#00fdff" />
                        </Grid>
                    </Border>

                    <!--Difficulty Distribution Chart-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <Grid>
                            <VerticalStackLayout>
                                <Label Text="Routes by Difficulty" 
                   Style="{StaticResource CardTitleStyle}"
                   />
                                <Label Text="Distribution of completed routes by difficulty level" 
                   Style="{StaticResource ChartSubtitleStyle}"
                   />
                                <charts:ChartView Chart="{Binding DifficultyDistributionChart}" 
                             Style="{StaticResource ChartContainerStyle}"
                             />

                                <!--Legend for difficulty levels-->
                                <FlexLayout Wrap="Wrap" JustifyContent="Start" AlignItems="Center" Margin="0,10,0,0">
                                    <BoxView Color="#f39c12" Style="{StaticResource LegendBoxStyle}" />
                                    <Label Text="Level 1" Style="{StaticResource LegendTextStyle}" Margin="5,0,15,0" />

                                    <BoxView Color="#e74c3c" Style="{StaticResource LegendBoxStyle}" />
                                    <Label Text="Level 2" Style="{StaticResource LegendTextStyle}" Margin="5,0,15,0" />

                                    <BoxView Color="#9b59b6" Style="{StaticResource LegendBoxStyle}" />
                                    <Label Text="Level 3" Style="{StaticResource LegendTextStyle}" Margin="5,0,15,0" />

                                    <BoxView Color="#3498db" Style="{StaticResource LegendBoxStyle}" />
                                    <Label Text="Level 4" Style="{StaticResource LegendTextStyle}" Margin="5,0,15,0" />

                                    <BoxView Color="#2ecc71" Style="{StaticResource LegendBoxStyle}" />
                                    <Label Text="Level 5" Style="{StaticResource LegendTextStyle}" Margin="5,0,15,0" />
                                </FlexLayout>
                            </VerticalStackLayout>

                            <!--Chart Loading Indicator-->
                            <ActivityIndicator IsRunning="{Binding IsDifficultyDistributionChartLoading}" 
                           IsVisible="{Binding IsDifficultyDistributionChartLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#3498db" />
                        </Grid>
                    </Border>

                    <!--Training Time by Day Chart-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <Grid>
                            <VerticalStackLayout>
                                <Label Text="Training Time by Day" 
                   Style="{StaticResource CardTitleStyle}"
                   />
                                <Label Text="Total minutes spent training on each day of the week" 
                   Style="{StaticResource ChartSubtitleStyle}"
                   />
                                <charts:ChartView Chart="{Binding TrainingTimeByDayChart}" 
                             Style="{StaticResource ChartContainerStyle}"
                             />
                            </VerticalStackLayout>

                            <!--Chart Loading Indicator-->
                            <ActivityIndicator IsRunning="{Binding IsTrainingTimeByDayChartLoading}" 
                           IsVisible="{Binding IsTrainingTimeByDayChartLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#3498db" />
                        </Grid>
                    </Border>

                    <!--Completion Rate by Difficulty Chart-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <Grid>
                            <VerticalStackLayout>
                                <Label Text="Completion Rate by Difficulty" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="Percentage of routes completed at each difficulty level" 
                   FontSize="12" TextColor="#666666" Margin="0,0,0,5" />
                                <charts:ChartView Chart="{Binding CompletionRateByDifficultyChart}" 
                             Style="{StaticResource ChartContainerStyle}" />
                            </VerticalStackLayout>

                            <!--  loading indicator -->
                            <ActivityIndicator IsRunning="{Binding IsCompletionRateChartLoading}" 
                           IsVisible="{Binding IsCompletionRateChartLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#3498db" />
                        </Grid>
                    </Border>

                    <!--Average Attempts per Difficulty Chart-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <Grid>
                            <VerticalStackLayout>
                                <Label Text="Average Attempts by Difficulty" Style="{StaticResource CardTitleStyle}" />
                                <Label Text="Average number of attempts needed to complete routes" 
                   FontSize="12" TextColor="#666666" Margin="0,0,0,5" />
                                <charts:ChartView Chart="{Binding AttemptsPerDifficultyChart}" 
                             Style="{StaticResource ChartContainerStyle}" />
                            </VerticalStackLayout>

                            <!-- Add this loading indicator -->
                            <ActivityIndicator IsRunning="{Binding IsAttemptsPerDifficultyChartLoading}" 
                           IsVisible="{Binding IsAttemptsPerDifficultyChartLoading}"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Color="#3498db" />
                        </Grid>
                    </Border>

                    <!--Recent Sessions-->
                    <Border Style="{StaticResource CardStyle}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>
                        <VerticalStackLayout>
                            <Label Text="Recent Sessions" Style="{StaticResource CardTitleStyle}" />

                            <CollectionView ItemsSource="{Binding RecentSessions}" 
                      SelectionMode="None" 
                      EmptyView="No recent sessions found">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:TrainingSession">
                                        <Grid Padding="5" ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                            <Border Grid.RowSpan="2" Grid.ColumnSpan="2" 
                               BackgroundColor="Transparent" 
                               Stroke="#EEEEEE" 
                               StrokeThickness="1"
                               Padding="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="8" />
                                                </Border.StrokeShape>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:DashboardViewModel}}, Path=ViewSessionDetailsCommand}"
                                                      CommandParameter="{Binding}" />
                                                </Border.GestureRecognizers>
                                            </Border>

                                            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Padding="10,5">
                                                <Label Text="{Binding FormattedDate}" 
                                   FontAttributes="Bold" 
                                   TextColor="#333333" />
                                                <Label Text="{Binding PanelType}" 
                                   FontSize="14" 
                                   TextColor="#666666" />
                                            </VerticalStackLayout>

                                            <HorizontalStackLayout Grid.Row="0" Grid.Column="1" 
                                              Spacing="5" 
                                              VerticalOptions="Center"
                                              Padding="10,5">
                                                <Label Text="{Binding CompletedRoutesCount}" 
                                   FontAttributes="Bold" 
                                   TextColor="#3498db" />
                                                <Label Text="/" 
                                   TextColor="#666666" />
                                                <Label Text="{Binding TotalRoutes}" 
                                   TextColor="#666666" />
                                                <Label Text="routes" 
                                   TextColor="#666666" 
                                   Margin="5,0,0,0" />
                                            </HorizontalStackLayout>

                                            <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                               Text="{Binding FormattedDuration, StringFormat='Duration: {0}'}" 
                               FontSize="14" 
                               TextColor="#666666" 
                               Padding="10,0,10,5" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>

               
                
            </Grid>
        </ScrollView>
    </RefreshView>
</ContentPage>